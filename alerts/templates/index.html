<!DOCTYPE html>
<html>
<head>
  <title>Stock Alert Monitor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

  <style>
    /* Custom styles for tabs to replace Bulma tabs */
    .custom-tabs-container ul {
      display: flex;
      list-style: none;
      margin: 0 0 20px 0;
      padding: 0;
      border-bottom: 2px solid #dbdbdb;
    }

    .custom-tabs-container li a {
      display: inline-block;
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      color: #363636;
      text-decoration: none;
    }

    .custom-tabs-container li.is-active a {
      border-bottom-color: #3273dc;
      color: #3273dc;
      font-weight: bold;
    }

    .custom-tabs-container li a:hover {
      border-bottom-color: #363636;
      color: #363636;
    }

    /* Style for rows where the target is hit (used by DataTables) */
    tr.target-hit {
      background-color: #d4edda !important; /* Use !important to override DataTables default styling */
    }
  </style>
</head>
<body class="section">
  <div class="container">
    <h1 class="title">ðŸ“ˆ Stock Alert Monitor</h1>

    <div class="buttons">
      <button id="btn-refresh-sheet" class="button is-link">Refresh Sheet</button>
      <button id="btn-refresh-all" class="button is-success">Manual Fetch Prices</button>
      <button id="btn-refresh-tab" class="button is-warning">Refresh Current Watchlist</button>
    </div>

    <div id="tabs" class="custom-tabs-container">
      <ul id="tab-list"></ul>
    </div>

    <div id="table-container"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    let watchlists = {};
    let currentTab = null;
    let stockDataTable = null; // Variable to hold the DataTable instance

    // --- Core Functions ---

    async function fetchWatchlists() {
      try {
        const res = await fetch("/api/watchlists/");
        const data = await res.json();
        watchlists = data.watchlists;
        renderTabs();
      } catch (error) {
        console.error("Failed to fetch watchlists:", error);
      }
    }

    function renderTabs() {
      const tabList = document.getElementById("tab-list");
      tabList.innerHTML = "";

      // Set the first tab as the current tab if none is selected
      if (!currentTab && Object.keys(watchlists).length) {
        currentTab = Object.keys(watchlists)[0];
      }

      for (const tabName in watchlists) {
        const li = document.createElement("li");
        if (tabName === currentTab) {
          li.classList.add("is-active");
        }
        li.innerHTML = `<a>${tabName}</a>`;
        li.onclick = () => {
          currentTab = tabName;
          // Visually update active tab and re-render the table
          document.querySelectorAll("#tab-list li").forEach(item => item.classList.remove("is-active"));
          li.classList.add("is-active");
          renderTable();
        };
        tabList.appendChild(li);
      }
      renderTable(); // Initial table render for the active tab
    }

    function renderTable() {
      if (!currentTab) return;

      const tableData = watchlists[currentTab] || [];

      // If a DataTable instance already exists, destroy it before creating a new one
      if (stockDataTable) {
        stockDataTable.destroy();
      }

      // Clear previous table and add the basic table structure for DataTables
      const container = document.getElementById("table-container");
      container.innerHTML = `<table id="stock-table" class="table is-striped is-fullwidth"></table>`;

      // Initialize DataTables
      stockDataTable = $('#stock-table').DataTable({
        data: tableData,
        columns: [
          { data: 'scrip_name', title: 'Scrip' },
          { data: 'target_price', title: 'Target' },
          { data: 'current_price', title: 'Current' },
          { data: 'status', title: 'Status' }
        ],
        // Use the createdRow callback to apply conditional styling
        createdRow: function(row, data, dataIndex) {
          if (data.status === "Target Hit!") {
            $(row).addClass('target-hit');
          }
        },
        // Optional: customize DataTables features
        paging: false,    // Disable pagination
        searching: true,  // Enable search box
        info: false,      // Disable "Showing x of y entries" text
        responsive: true // Enable responsive design
      });
    }

    // --- Event Listeners for Buttons ---

    document.getElementById("btn-refresh-sheet").onclick = async () => {
      console.log("Refreshing sheet...");
      const res = await fetch("/api/refresh-sheet/", { method: "POST" });
      watchlists = (await res.json()).watchlists;
      renderTabs(); // Re-render everything from tabs down
    };

    document.getElementById("btn-refresh-all").onclick = async () => {
      console.log("Refreshing all prices...");
      const res = await fetch("/api/refresh-all-prices/", { method: "POST" });
      watchlists = (await res.json()).watchlists;
      renderTable(); // Just re-render the current table with new data
    };

    document.getElementById("btn-refresh-tab").onclick = async () => {
      if (!currentTab) return;
      console.log(`Refreshing tab: ${currentTab}`);
      const res = await fetch(`/api/refresh-tab/${currentTab}/`, { method: "POST" });
      watchlists = (await res.json()).watchlists;
      renderTable(); // Just re-render the current table
    };

    // --- Initial Load ---
    fetchWatchlists();
  </script>
</body>
</html>
