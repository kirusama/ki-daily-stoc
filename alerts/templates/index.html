<!DOCTYPE html>
<html>

<head>
  <title>Stock Alert Monitor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

  <style>
    /* New styles for button-based tabs, inspired by your example */
    .tab-container {
      overflow: hidden;
      border: 1px solid #dbdbdb;
      background-color: #f5f5f5;
      margin-bottom: 20px;
    }

    .tab-container .tablink {
      background-color: inherit;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: background-color 0.3s;
      font-size: 16px;
    }

    .tab-container .tablink:hover {
      background-color: #e6e6e6;
    }

    /* Style for the active tab button */
    .tab-container .tablink.active {
      background-color: #fff;
      border-bottom: 2px solid #3273dc;
      font-weight: 600;
      color: #3273dc;
    }

    /* Style for rows where the target is hit (used by DataTables) */
    tr.target-hit {
      background-color: #d4edda !important;
      /* !important to override DataTables styling */
    }
  </style>
</head>

<body class="section">
  <div class="container">
    <h1 class="title">ðŸ“ˆ Stock Alert Monitor</h1>

    <div class="buttons">
      <button id="btn-refresh-sheet" class="button is-link">Refresh Sheet</button>
      <button id="btn-refresh-all" class="button is-success">Manual Fetch Prices</button>
      <button id="btn-refresh-tab" class="button is-warning">Refresh Current Watchlist</button>
    </div>

    <div id="tab-buttons" class="tab-container"></div>

    <div id="table-container"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    let watchlists = {};
    let currentTab = null;
    let stockDataTable = null; // Variable to hold the DataTable instance

    // --- Tab and Table Rendering ---

    /**
     * Handles the logic for switching tabs, updating styles, and re-rendering the table.
     */
    function switchTab(tabName, clickedButton) {
      // 1. Update the global variable for the current tab
      currentTab = tabName;

      // 2. Update the 'active' class on all tab buttons
      const tablinks = document.querySelectorAll("#tab-buttons .tablink");
      tablinks.forEach(btn => btn.classList.remove('active'));
      clickedButton.classList.add('active');

      // 3. Render the table with data from the newly selected tab
      renderTable();
    }

    /**
     * Creates and populates the tab buttons based on the available watchlists.
     */
    function renderTabs() {
      const tabContainer = document.getElementById("tab-buttons");
      tabContainer.innerHTML = ""; // Clear existing tabs

      // Check if watchlists exist
      if (Object.keys(watchlists).length === 0) {
        // No watchlists available, show message in table
        renderTable();
        return;
      }

      // If currentTab is invalid or not set, default to the first available watchlist
      if (!currentTab || !watchlists[currentTab]) {
        currentTab = Object.keys(watchlists)[0] || null;
      }

      let activeTabButton = null;

      // Create a button for each watchlist
      for (const tabName in watchlists) {
        const button = document.createElement("button");
        button.className = "tablink";
        button.innerText = tabName;
        // Assign the switchTab function to the button's click event
        button.onclick = () => switchTab(tabName, button);
        tabContainer.appendChild(button);

        if (tabName === currentTab) {
          activeTabButton = button;
        }
      }

      // Programmatically "click" the first/active tab to set the initial state
      if (activeTabButton) {
        activeTabButton.click();
      } else {
        // Handle case where there are no watchlists
        renderTable(); // This will show an empty table
      }
    }

    /**
     * Renders the stock data table using the DataTables library.
     */
    function renderTable() {
      const tableData = (currentTab && watchlists[currentTab]) ? watchlists[currentTab] : [];

      // If a DataTable instance already exists, destroy it before re-creating it
      if (stockDataTable) {
        stockDataTable.destroy();
      }

      const container = document.getElementById("table-container");

      // Check if there are no watchlists at all
      if (Object.keys(watchlists).length === 0) {
        container.innerHTML = `
          <div class="notification is-info has-text-centered">
            <p><strong>No watchlists found!</strong></p>
            <p>Please click the "Refresh Watchlist" button to load your data.</p>
          </div>
        `;
        return;
      }

      // Add the basic table structure for DataTables
      container.innerHTML = `<table id="stock-table" class="table is-striped is-fullwidth"></table>`;

      // Initialize DataTables
      stockDataTable = $('#stock-table').DataTable({
        data: tableData,
        columns: [
          { data: 'scrip_name', title: 'Scrip' },
          { data: 'target_price', title: 'Target' },
          { data: 'current_price', title: 'Current' },
          { data: 'status', title: 'Status' }
        ],
        createdRow: function (row, data, dataIndex) {
          if (data.status === "Target Hit!") {
            $(row).addClass('target-hit');
          }
        },
        paging: false,
        searching: true,
        info: false,
        responsive: true
      });
    }

    // --- Data Fetching and Event Listeners ---

    async function fetchWatchlists() {
      try {
        const res = await fetch("/api/watchlists/");
        const data = await res.json();
        watchlists = data.watchlists;
        renderTabs();
      } catch (error) {
        console.error("Failed to fetch watchlists:", error);
      }
    }

    document.getElementById("btn-refresh-sheet").onclick = async () => {
      console.log("Refreshing sheet...");
      const res = await fetch("/api/refresh-sheet/", { method: "POST" });
      watchlists = (await res.json()).watchlists;
      renderTabs(); // Re-render everything from tabs down
    };

    document.getElementById("btn-refresh-all").onclick = async () => {
      console.log("Refreshing all prices...");
      const res = await fetch("/api/refresh-all-prices/", { method: "POST" });
      watchlists = (await res.json()).watchlists;
      renderTable(); // Just re-render the current table with new data
    };

    // AFTER
    document.getElementById("btn-refresh-tab").onclick = async () => {
      if (!currentTab) return;
      console.log(`Refreshing tab: ${currentTab}`);
      let res = await fetch(`/api/refresh-tab/${currentTab}/`, { method: "POST" });

      // New logic: Only update the data for the specific tab
      let responseData = await res.json();
      watchlists[responseData.tab_name] = responseData.data;

      renderTable(); // Re-render the table with the fresh data
    };

    // --- Initial Load ---
    // Check if watchlists exist on page load, if not show message
    renderTabs();
  </script>
</body>

</html>
